<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GastoFlow SDK V25</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.5rem; }
    </style>
    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai",
                "react": "https://esm.run/react@18",
                "react-dom/client": "https://esm.run/react-dom@18/client"
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        import React, { useState, useEffect } from "react";
        import { createRoot } from "react-dom/client";

        // --- TU API KEY VA AQUÃ ---
        const API_KEY = "AIzaSyBymDjTMhj4abQ2pXxVVQBIDZB8jtRmSFY"; 

        // Inicializamos el Robot Oficial de Google
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        function App() {
            const [cargando, setCargando] = useState(false);
            const [msj, setMsj] = useState("Listo");
            const [config, setConfig] = useState(() => {
                const s = localStorage.getItem('gf_v25_sdk');
                return s ? JSON.parse(s) : { sel: 'Personal', noms: ['Personal', 'Obra 1'], gastos: { 'Personal': [], 'Obra 1': [] } };
            });

            useEffect(() => { localStorage.setItem('gf_v25_sdk', JSON.stringify(config)); }, [config]);

            const fileToGenerativePart = async (file) => {
                const base64EncodedDataPromise = new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });
                return {
                    inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
                };
            };

            const procesarIA = async (e) => {
                const file = e.target.files[0]; if(!file) return;
                setCargando(true);
                setMsj("Conectando con Google...");
                
                try {
                    const imagePart = await fileToGenerativePart(file);
                    
                    // Usamos la librerÃ­a oficial para generar contenido
                    const result = await model.generateContent([
                        "Analiza este ticket. Responde estrictamente en este formato: Comercio|Monto. Ejemplo: HomeDepot|120.50", 
                        imagePart
                    ]);
                    
                    const response = await result.response;
                    const text = response.text();
                    
                    const [d, m] = text.split('|');
                    const monto = m ? parseFloat(m.replace(/[^0-9.]/g, '')) : 0;
                    
                    let nG = {...config.gastos};
                    nG[config.sel] = [{id:Date.now(), d:(d||"Gasto").trim(), m:monto, f:new Date().toLocaleDateString()}, ...(nG[config.sel] || [])];
                    setConfig({...config, gastos: nG});
                    setMsj("Â¡LeÃ­do!");
                    
                } catch (error) {
                    console.error(error);
                    alert("Error detallado: " + error.toString());
                    setMsj("Error");
                }
                setCargando(false);
            };

            const total = (config.gastos[config.sel] || []).reduce((a, b) => a + b.m, 0);

            return (
                <div className="max-w-md mx-auto p-5 pb-32">
                    <header className="flex justify-between items-center py-6">
                        <h1 className="text-2xl font-black text-blue-400 italic">GASTOFLOW PRO</h1>
                        <label className="bg-blue-600 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg cursor-pointer">
                            ðŸ“·<input type="file" accept="image/*" capture="environment" className="hidden" onChange={procesarIA} />
                        </label>
                    </header>
                    <div className="glass p-6 mb-4">
                        <p className="text-[10px] font-bold text-blue-400 uppercase mb-1">{config.sel}</p>
                        <h2 className="text-4xl font-black">${total.toLocaleString('es-MX', {minimumFractionDigits:2})}</h2>
                    </div>
                    <div className="space-y-3">
                        {cargando && <div className="p-4 glass text-center text-blue-400 animate-pulse font-bold">{msj}</div>}
                        {(config.gastos[config.sel] || []).map(g => (
                            <div key={g.id} className="glass p-4 flex justify-between items-center">
                                <div><p className="font-bold text-sm">{g.d}</p><p className="text-[9px] opacity-50">{g.f}</p></div>
                                <p className="font-black text-lg text-blue-400">${g.m.toFixed(2)}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
            
                   

           

                  

                    
                       
 
                        

                   
           
     
